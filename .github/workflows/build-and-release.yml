name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build application
        run: pnpm tauri build

      - name: Get version
        id: get_version
        run: |
          if ("${{ github.ref }}" -match "^refs/tags/v") {
            $version = "${{ github.ref }}" -replace "^refs/tags/", ""
          } else {
            $version = "v0.1.0-dev.${{ github.run_number }}"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Generate release notes
        id: release_notes
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $notes = @"
          ## dev-boom $version

          ### ğŸ†• æ–°å¢åŠŸèƒ½

          - **æ‰˜ç›˜æ™ºèƒ½æ¢å¤**: ä»æ‰˜ç›˜æ‰“å¼€æ—¶è‡ªåŠ¨æ¢å¤æœ€åä½¿ç”¨çš„çª—å£æ¨¡å¼ï¼ˆä¸»çª—å£/è¿·ä½ çª—å£ï¼‰
          - **å¿«é€Ÿçª—å£åˆ‡æ¢**: æ‰˜ç›˜åŒå‡»åœ¨ä¸»çª—å£å’Œè¿·ä½ çª—å£ä¹‹é—´å¿«é€Ÿåˆ‡æ¢
          - **IDE åç§°è‡ªåŠ¨å¡«å……**: é€‰æ‹©å¯æ‰§è¡Œæ–‡ä»¶æ—¶è‡ªåŠ¨æå–å¹¶è§„èŒƒåŒ– IDE åç§°

          - **å¼€å‘è¯­è¨€ç»Ÿè®¡**: è‡ªåŠ¨è¯†åˆ«å’Œç»Ÿè®¡é¡¹ç›®ä¸­ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ”¯æŒ 40+ ç§è¯­è¨€
          - **è¯­è¨€å¯è§†åŒ–**: é¡¹ç›®å¡ç‰‡æ˜¾ç¤ºè¯­è¨€æ‘˜è¦ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦ç»†çš„ä»£ç è¡Œæ•°å’Œå æ¯”åˆ†å¸ƒ
          - **æ™ºèƒ½æ‰«æ**: é¡¹ç›®æ‰«ææ—¶è‡ªåŠ¨æ›´æ–°å·²æœ‰é¡¹ç›®çš„è¯­è¨€ç»Ÿè®¡æ•°æ®

          - **ä¼˜åŒ–çª—å£ç®¡ç†**: ç»Ÿä¸€çš„çª—å£å…³é—­é€»è¾‘ï¼Œæ‰€æœ‰çª—å£å…³é—­æ—¶éšè—åˆ°æ‰˜ç›˜
          - **å¢å¼ºæ‰˜ç›˜åŠŸèƒ½**: æ–°å¢"æ˜¾ç¤ºä¸»çª—å£"ã€"æ˜¾ç¤ºè¿·ä½ çª—å£"ã€"éšè—æ‰€æœ‰çª—å£"é€‰é¡¹
          - **IDE æ‰«æä¼˜åŒ–**: æ‰«æç»“æœç›´æ¥åœ¨å¼¹çª—ä¸­å±•ç¤ºï¼Œæä¾›è¯¦ç»†çš„å‘ç° IDE åˆ—è¡¨

          - **é¡¹ç›®æ‰«æä¼˜åŒ–**: é»˜è®¤æ‰«ææ·±åº¦è°ƒæ•´ä¸º 1ï¼Œå‡å°‘ä¸å¿…è¦çš„æ·±åº¦æ‰«æ
          - **æ™ºèƒ½æç¤º**: åŒºåˆ†æ–°å¢é¡¹ç›®å’Œæ›´æ–°é¡¹ç›®çš„æ‰«æç»“æœæç¤º

          ### âœ¨ æ ¸å¿ƒåŠŸèƒ½

          - é¡¹ç›®ç®¡ç†å™¨ï¼šå¿«é€Ÿæ‰«æå’Œç®¡ç†å¼€å‘é¡¹ç›®
          - IDE é›†æˆï¼šæ”¯æŒå¤šä¸ªå¼€å‘å·¥å…·é…ç½®å’Œè‡ªåŠ¨æ£€æµ‹
          - ç»ˆç«¯é›†æˆï¼šå¿«é€Ÿåœ¨é¡¹ç›®ç›®å½•ä¸­æ‰“å¼€ç»ˆç«¯
          - æ”¶è—ç³»ç»Ÿï¼šæ ‡è®°å¸¸ç”¨é¡¹ç›®å¿«é€Ÿè®¿é—®
          - ä¸»é¢˜åˆ‡æ¢ï¼šæ”¯æŒæµ…è‰²/æ·±è‰²ä¸»é¢˜
          - è¯­è¨€åˆ†æï¼šè‡ªåŠ¨åˆ†æé¡¹ç›®ä»£ç ç»„æˆ
          - è¿·ä½ çª—å£ï¼šç´§å‡‘çš„é¡¹ç›®å¿«é€Ÿå¯åŠ¨ç•Œé¢

          ### ä¸‹è½½è¯´æ˜

          - **dev-boom_*_x64-setup.exe**: NSIS å®‰è£…ç¨‹åºï¼ˆæ¨èï¼‰
          - **dev-boom.exe**: ä¾¿æºç‰ˆï¼Œæ— éœ€å®‰è£…
          - **.msi**: Windows å®‰è£…åŒ…

          ### ç³»ç»Ÿè¦æ±‚

          - Windows 10/11 x64
          "@
          "notes<<EOF" >> $env:GITHUB_OUTPUT
          $notes >> $env:GITHUB_OUTPUT
          "EOF" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: List build artifacts
        run: |
          echo "=== release dir ==="
          Get-ChildItem -Path "src-tauri\target\release" -File | Select-Object Name, Length
          echo "=== bundle\nsis ==="
          Get-ChildItem -Path "src-tauri\target\release\bundle\nsis" -File -ErrorAction SilentlyContinue | Select-Object Name, Length
          echo "=== bundle\msi ==="
          Get-ChildItem -Path "src-tauri\target\release\bundle\msi" -File -ErrorAction SilentlyContinue | Select-Object Name, Length
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: dev-boom ${{ steps.get_version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}
          files: |
            src-tauri/target/release/dev-boom.exe
            src-tauri/target/release/bundle/nsis/dev-boom_*_x64-setup.exe
            src-tauri/target/release/bundle/msi/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
